<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Local ERNIE Chat</title>
<style>
  :root {
    --bg:#0d1017; --fg:#e6e9f2; --muted:#99a3b5;
    --accent:#56a4ff; --me:#162a44; --ai:#141c26;
  }
  body {
    margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    display:flex; flex-direction:column; height:100vh;
  }
  header {
    padding:10px 16px; background:#111620;
    display:flex; align-items:center; justify-content:space-between;
    border-bottom:1px solid #1e2532;
  }
  header h1 {font-size:16px; margin:0;}
  #chat {
    flex:1; overflow-y:auto; padding:20px; scroll-behavior:smooth;
  }
  .bubble {
    max-width:70ch; margin:8px 0; padding:12px 16px;
    border-radius:18px; line-height:1.4; white-space:pre-wrap;
  }
  .user { background:var(--me); margin-left:auto; border-bottom-right-radius:6px;}
  .bot { background:var(--ai); margin-right:auto; border-bottom-left-radius:6px;}
  form {
    display:flex; gap:8px; padding:10px; border-top:1px solid #1e2532;
    background:#0f141d;
  }
  textarea {
    flex:1; resize:none; height:60px; border:none;
    background:#131a26; color:var(--fg); border-radius:12px;
    padding:10px 12px; font-size:15px;
  }
  button {
    background:var(--accent); color:#fff; border:none;
    border-radius:12px; padding:10px 16px; font-weight:600;
    cursor:pointer;
  }
  #mic { background:#26354f; }
  #status { font-size:12px; color:var(--muted); padding:4px 16px; }
</style>
</head>
<body>
<header>
  <h1>Chat with ERNIE 4.5 (0.3 B)</h1>
  <button id="mic" title="Hold to speak">ðŸŽ¤</button>
</header>
<div id="chat"></div>
<form id="form">
  <textarea id="input" placeholder="Type a message..."></textarea>
  <button id="send" type="submit">Send</button>
</form>
<div id="status">Loading modelâ€¦</div>

<script type="module">
import { pipeline } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const form = document.getElementById("form");
const status = document.getElementById("status");
const mic = document.getElementById("mic");

function add(text, who) {
  const b=document.createElement("div");
  b.className="bubble "+who;
  b.textContent=text.trim();
  chat.appendChild(b);
  chat.scrollTop=chat.scrollHeight;
  return b;
}
function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u);
}

status.textContent="Downloading ERNIE 4.5 0.3 Bâ€¦";
let gen;
try{
  gen=await pipeline("text-generation","onnx-community/ERNIE-4.5-0.3B-ONNX",
    {device:"webgpu",dtype:"q4",
     progress_callback:p=>status.textContent=`Loadingâ€¦ ${(p*100|0)}%`});
  status.textContent="Ready!";
}catch(e){status.textContent="Load failed: "+e.message;throw e;}

const history=[];

async function reply(user){
  add(user,"user");
  const messages=[{role:"system",content:"You are a friendly, helpful assistant."},
    ...history.flatMap(x=>[{role:"user",content:x.u},{role:"assistant",content:x.a}]),
    {role:"user",content:user}];
  const out=await gen(messages,{max_new_tokens:120,temperature:0.7});
  const text=out?.[0]?.generated_text?.at(-1)?.content?.trim()||"â€¦";
  history.push({u:user,a:text});
  add(text,"bot"); speak(text);
}

form.onsubmit=e=>{
  e.preventDefault();
  const val=input.value.trim(); if(!val)return;
  input.value=""; reply(val);
};

// Speech input
let rec;
function makeRec(){
  const R=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!R)return null;
  const r=new R(); r.lang="en-US"; r.continuous=false;
  r.onresult=e=>{
    const t=e.results[0][0].transcript;
    reply(t);
  };
  r.onend=()=>mic.textContent="ðŸŽ¤";
  return r;
}
rec=makeRec();
mic.onclick=()=>{
  if(!rec){alert("Speech input not supported.");return;}
  if(mic.textContent==="ðŸŽ¤"){rec.start();mic.textContent="ðŸ›‘";}
  else{rec.stop();mic.textContent="ðŸŽ¤";}
};

// greet
add("ðŸ‘‹ Hi! I'm ERNIE 4.5 running locally in your browser. Speak or type to start!","bot");
</script>
</body>
</html>
